<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <title>test</title>
    <link type="text/css" rel="stylesheet" href="https://milamwhitt.github.io/blog/assests-css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="https://milamwhitt.github.io/blog/assests-css/assets-css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="https://milamwhitt.github.io/blog/assests-css/hljs-github.min.css"/>
  </head>
  <body>
    <article class="markdown-body"><h1 id="vfio---how-i-game-on-linux"><a class="header-link" href="#vfio---how-i-game-on-linux"></a>VFIO - How I game on Linux</h1>
      <p></p>
<h2 id="requirements"><a class="header-link" href="#requirements"></a>Requirements</h2>
<p>As any gamer I&#39;m fairly picky about my setup and its performance. So to start out with lets define some requirements;</p>
<ol class="list">
  <li>God blesss amerika</li>
</ol>
<h2 id="zero-to-vfio-hero"><a class="header-link" href="#zero-to-vfio-hero"></a>Zero to VFIO Hero</h2>
<h3 id="getting-the-gpu-setup-with-vfio"><a class="header-link" href="#getting-the-gpu-setup-with-vfio"></a>Getting the GPU setup with VFIO</h3>
      <p>Test</p>
<pre class="hljs"><code>$ lspci -v
<span class="hljs-number">02</span>:<span class="hljs-number">00.0</span> VGA compatible controller: NVIDIA Corporation GM206 [GeForce GTX <span class="hljs-number">960</span>] (rev a1) (prog-<span class="hljs-keyword">if</span> <span class="hljs-number">00</span> [VGA controller])

<span class="hljs-number">02</span>:<span class="hljs-number">00.1</span> Audio device: NVIDIA Corporation Device <span class="hljs-number">0</span>fba (rev a1)
        Subsystem: ASUSTeK Computer Inc. Device <span class="hljs-number">854</span>d
        Flags: bus master, fast devsel, latency <span class="hljs-number">0</span>, IRQ <span class="hljs-number">18</span>
        Memory <span class="hljs-keyword">at</span> dd080000 (<span class="hljs-number">32</span>-bit, non-prefetchable) [size=<span class="hljs-number">16</span>K]
        Capabilities: &lt;<span class="hljs-keyword">access</span> denied&gt;
        Kernel driver <span class="hljs-keyword">in</span> <span class="hljs-keyword">use</span>: vfio-pci
        Kernel modules: snd_hda_intel</code></pre><pre class="hljs"><code><span class="hljs-selector-tag">IOMMU</span> <span class="hljs-selector-tag">Group</span> <span class="hljs-selector-tag">12</span> <span class="hljs-selector-tag">01</span><span class="hljs-selector-pseudo">:00.0</span> <span class="hljs-selector-tag">VGA</span> <span class="hljs-selector-tag">compatible</span> <span class="hljs-selector-tag">controller</span> <span class="hljs-selector-attr">[0300]</span>: <span class="hljs-selector-tag">NVIDIA</span> <span class="hljs-selector-tag">Corporation</span> <span class="hljs-selector-tag">GP104</span> <span class="hljs-selector-attr">[GeForce GTX 1080]</span> <span class="hljs-selector-attr">[10de:1b80]</span> (rev a1)
<span class="hljs-selector-tag">IOMMU</span> <span class="hljs-selector-tag">Group</span> <span class="hljs-selector-tag">12</span> <span class="hljs-selector-tag">01</span><span class="hljs-selector-pseudo">:00.1</span> <span class="hljs-selector-tag">Audio</span> <span class="hljs-selector-tag">device</span> <span class="hljs-selector-attr">[0403]</span>: <span class="hljs-selector-tag">NVIDIA</span> <span class="hljs-selector-tag">Corporation</span> <span class="hljs-selector-tag">GP104</span> <span class="hljs-selector-tag">High</span> <span class="hljs-selector-tag">Definition</span> <span class="hljs-selector-tag">Audio</span> <span class="hljs-selector-tag">Controller</span> <span class="hljs-selector-attr">[10de:10f0]</span> (rev a1)
<span class="hljs-selector-tag">IOMMU</span> <span class="hljs-selector-tag">Group</span> <span class="hljs-selector-tag">13</span> <span class="hljs-selector-tag">02</span><span class="hljs-selector-pseudo">:00.0</span> <span class="hljs-selector-tag">VGA</span> <span class="hljs-selector-tag">compatible</span> <span class="hljs-selector-tag">controller</span> <span class="hljs-selector-attr">[0300]</span>: <span class="hljs-selector-tag">NVIDIA</span> <span class="hljs-selector-tag">Corporation</span> <span class="hljs-selector-tag">GM206</span> <span class="hljs-selector-attr">[GeForce GTX 960]</span> <span class="hljs-selector-attr">[10de:1401]</span> (rev a1)
<span class="hljs-selector-tag">IOMMU</span> <span class="hljs-selector-tag">Group</span> <span class="hljs-selector-tag">13</span> <span class="hljs-selector-tag">02</span><span class="hljs-selector-pseudo">:00.1</span> <span class="hljs-selector-tag">Audio</span> <span class="hljs-selector-tag">device</span> <span class="hljs-selector-attr">[0403]</span>: <span class="hljs-selector-tag">NVIDIA</span> <span class="hljs-selector-tag">Corporation</span> <span class="hljs-selector-tag">Device</span> <span class="hljs-selector-attr">[10de:0fba]</span> (rev a1)</code></pre><h3 id="creating-the-vm"><a class="header-link" href="#creating-the-vm"></a>Creating the VM</h3>
<p>One of the first steps to getting your VM up and running is installing and setting up libvirt/QEMU. Part of this process includes getting the OVMF EDK II UEFI firmware setup so QEMU can use it. I found that <a href="https://ubuntuforums.org/showthread.php?t=2292667&amp;p=13347714#post13347714">this forum thread</a> was the best source for getting that setup correctly such that virt-manager could see the firmware.</p>
<p>The rest of the VM creation process was fairly straightforward and similarly followed the Arch wiki&#39;s guide. After installing Windows 10 I was ready to attempt GPU passthrough. I swapped my DP cable onto the secondary GPU and moved to HDMI for my primary GPU (losing 144hz/GSync on the Linux side a trade off I&#39;m <em>ok</em> with). After adding the two PCI devices via virt-manager, restarting the VM and swapping display inputs, I could see my windows install!</p>
<p>For the moment I lacked any proper hardware input to the VM, so to resolve this temporarily I plugged in a seperate keyboard/mouse and used USB passthrough to force-add them to the VM.</p>
<p>I was now ready to install the NVidia drivers on the guest. I first tried doing this via the drivers provided on Nvidias site. However after a reboot it appeared Windows was not taking to the driver and was still stuck in low resolution. I attempted to install the drivers two more times once through the OEM Nvidia pages and once through Windows device manager. Neither of these worked and I finally debugged the problem enough to discover the following message on my GPU device:</p>
<pre class="hljs"><code><span class="hljs-symbol">Windows</span> has stopped this device <span class="hljs-keyword">because </span><span class="hljs-keyword">it </span>has reported problems. (<span class="hljs-meta">Code</span> <span class="hljs-number">43</span>)</code></pre><p>Some quick research online provided a few suggestions but the most promising was that Nvidias drivers appear to detect the existance of a VM and flip off. I had read a few prior posts about people swapping some configuration in their libvirt/qemu XML config, so I popped open <code>virsh edit</code> and added the following;</p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">features</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">acpi</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">apic</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">hyperv</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relaxed</span> <span class="hljs-attr">state</span>=<span class="hljs-string">'on'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vapic</span> <span class="hljs-attr">state</span>=<span class="hljs-string">'on'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spinlocks</span> <span class="hljs-attr">state</span>=<span class="hljs-string">'on'</span> <span class="hljs-attr">retries</span>=<span class="hljs-string">'8191'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vendor_id</span> <span class="hljs-attr">state</span>=<span class="hljs-string">'on'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'whatever'</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">hyperv</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">kvm</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">hidden</span> <span class="hljs-attr">state</span>=<span class="hljs-string">'on'</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">kvm</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">vmport</span> <span class="hljs-attr">state</span>=<span class="hljs-string">'off'</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">features</span>&gt;</span>
</code></pre><p>Rebooting with this configuration caused the driver to work and a full resolution screen (with 144hz and GSync no less) was displayed!</p>
<h3 id="keyboard-&-mouse"><a class="header-link" href="#keyboard-&-mouse"></a>Keyboard &amp; Mouse</h3>
<p>My next task was getting keyboard and mouse input working. Most of my reading up to this point suggested that the only way to get cross host/guest input was using something like Synergy, which would have been unacceptable due to my latency requirements. I finally found a few posts on r/vfio that showed using libevdev device passthrough. After some more research I discovered <a href="https://passthroughpo.st/using-evdev-passthrough-seamless-vm-input/">this</a> blog post which described the process well. I added the XML required for this and also made sure to flip the virtual keyboard/mouse from ps2 to virtio (which solves a key-sticking issue). After booting the VM I found my keyboard and mouse immedietly passed through to the VM. Pressing the left and right ctrl keys at the same time caused the input to toggle between guest and host. While the input <em>feels</em> different in Windows I wasn&#39;t able to discern any input lag or other input problems.</p>
<h4 id="update"><a class="header-link" href="#update"></a>Update</h4>
<p>I ended up having a few issues in game with keys sticking and things that <em>felt</em> like they where related to <a href="https://en.wikipedia.org/wiki/Rollover_(key">key rollover</a>). I was under the impression that adding a virtio keyboard/mouse would solve these, but I wasn&#39;t seen that result. After some further investigation I found that I had to install virtio drivers within windows. To do this I downloaded the latest virtio-win iso from <a href="https://docs.fedoraproject.org/quick-docs/en-US/creating-windows-virtual-machines-using-virtio-drivers.html">this fedora project page</a> and then followed the instructions on <a href="https://access.redhat.com/articles/2488201">this redhat page</a>. After installing the drivers all key sticking and other issues, and I also noticed the &quot;different&quot; feel I described above went away (however arbitrary that is...)</p>
<h3 id="sound"><a class="header-link" href="#sound"></a>Sound</h3>
<p>Again based on my research I had heard a lot of varying information on how to get sound working. Most people seemed to fail or describe the process as complicated and error-prone. It turned out to be fairly easy and I used <a href="https://www.reddit.com/r/VFIO/comments/4kuvxs/setting_up_a_kvmqemu_vga_passthrough_gaming_vm/">this reddit post</a> for instructions. After enabling everything and rebooting I swapped my Windows output device and everything seemed to work. I have yet to notice any crackling/snapping/lag/etc with audio, but I don&#39;t plan on passing through any mic input (which makes this easier).</p>
<h3 id="performance"><a class="header-link" href="#performance"></a>Performance</h3>
<p>There is a ton of information online on improving VM performance however in my initial tests I was very pleased with the results I was getting in Overwatch. Within test range (which is fairly synthetic, but a useful data point nonetheless) I managed upwards of 160-180FPS, more than enough for my standard 143FPS cap. I did end up adding a few performance tweaks I read about online mostly because I understand what they would do based on my own past experience/knowledge making them feel a bit less snake-oily. The two big ones are CPU pinning (do this!) and using huge pages for memory backing.</p>
<h3 id="monitor-swapping"><a class="header-link" href="#monitor-swapping"></a>Monitor Swapping</h3>
<p>Within Dells monitor firmware it allows you to configure some custom buttons to do &quot;quick&quot; options. I set these buttons to swap between the two inputs so getting control over the VM is two button presses (one selection, one confirmation) away. This actually makes the entire process of &quot;swapping&quot; to my Windows side being pressing two buttons on the monitor, and the left/right ctrl buttons on my keyboard.</p>
<h2 id="thoughts"><a class="header-link" href="#thoughts"></a>Thoughts</h2>
<p>Overall I&#39;m <em>extremely</em> pleased with the result. I&#39;ve spent a bit of time testing various games (hilariously enough I haven&#39;t fully <em>played</em> a game yet, so we&#39;ll see how that goes) and the performance/latency seems to be nearly the same as my original desktop setup. I may at some point swap the host and guests cards so that my Linux side uses the 960 and my Windows VM can take full advantage of the 1080, however that will depend on the in-game performance I see. The ability to run my standard i3/Linux setup for everything I need while being able to have an almost frictionless swap to a performant Windows VM is so far unmatched in my opinion.</p>
<p>There are various additional benefits to running Windows in a VM (snapshots, etc) that I won&#39;t enumerate here, but I suggest doing your own research and figuring out if this strategy is right for you. While this process took a few hours in total to setup / work out the kinks, anyone with general Linux knowledge will probablly feel comfortable getting things working. I would caution folks attempting this that the pure quantiy of information out there can be more of a curse than a blessing at most points, so do a <em>lot</em> of research and figure out what will work well for your setup.</p>
<p>Finally if you have any specific questions or just wanna show off your VFIO setup, feel free to hit me up <a href="https://twitter.com/b1naryth1ef">on twitter</a>.</p>
<h4 id="libvirt/qemu-vm-configuration"><a class="header-link" href="#libvirt/qemu-vm-configuration"></a>libvirt/QEMU VM Configuration</h4>
    <span class="hljs-tag">&lt;<span class="hljs-name">qemu:arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'-object'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">qemu:arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'input-linux,id=mouse1,evdev=/dev/input/event9'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">qemu:arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'-object'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">qemu:arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'input-linux,id=kbd1,evdev=/dev/input/event10,grab_all=on,repeat=on'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">qemu:env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'QEMU_AUDIO_DRV'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'pa'</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">qemu:env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'QEMU_PA_SERVER'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'/run/user/1000/pulse/native'</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">qemu:commandline</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">domain</span>&gt;</span></code></pre>    </article>
  </body>
</html>
